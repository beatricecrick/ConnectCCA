<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Members</title>
    <style>
        .dropdown-content {
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }
        .dropdown-content ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .dropdown-content ul li {
            padding: 8px 16px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        .dropdown-content ul li:hover {
            background-color: #ddd;
        }
    </style>
</head>
<body>
    <h1>Add Members to Group Chat</h1>
    <div id="addMembers">
        <label for="memberName">Enter member name:</label>
        <input type="text" id="memberName" oninput="searchUsers()" />
        <div class="dropdown-content" id="searchResults">
            <ul></ul>
        </div>
        <button onclick="addMember()">Add Member</button>
        <p id="error-message" style="color: red;"></p> <!-- Error message display -->
    </div>
    <ul id="membersList"></ul>
    <button onclick="confirmMembers()">Confirm</button>
    <button onclick="goBack()">Back</button>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const locationName = urlParams.get('location');
        const owner = urlParams.get('owner'); // Get the owner from the URL
        const membersList = document.getElementById('membersList');
        const searchResults = document.getElementById('searchResults').querySelector('ul');
        let members = [owner]; // Automatically add the owner to the members list
        let searchResultsCache = [];

        // Display the owner in the members list
        const ownerItem = document.createElement('li');
        ownerItem.textContent = owner;
        membersList.appendChild(ownerItem);

        // Search users as the user types
        function searchUsers() {
            const query = document.getElementById('memberName').value.trim().toLowerCase();
            if (query) {
                fetch(`/searchUsers?query=${query}`)
                    .then(response => response.json())
                    .then(users => {
                        searchResultsCache = users;
                        searchResults.innerHTML = '';
                        users.slice(0, 5).forEach(user => { // Limit to 5 results
                            if (user.toLowerCase().startsWith(query) && user !== owner && !members.includes(user)) { // Exclude the owner and already added members from search results
                                const item = document.createElement('li');
                                item.textContent = user;
                                item.onclick = () => selectUser(user);
                                searchResults.appendChild(item);
                            }
                        });
                        document.getElementById('searchResults').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            } else {
                searchResults.innerHTML = '';
                document.getElementById('searchResults').style.display = 'none';
            }
        }

        // Select a user from the search results
        function selectUser(user) {
            document.getElementById('memberName').value = user;
            searchResults.innerHTML = '';
            document.getElementById('searchResults').style.display = 'none';
        }

        // Add member to the local list and display it
        function addMember() {
            const memberName = document.getElementById('memberName').value.trim();
            if (memberName && searchResultsCache.includes(memberName) && !members.includes(memberName)) {
                members.push(memberName);
                const item = document.createElement('li');
                item.textContent = memberName;
                membersList.appendChild(item);
                document.getElementById('memberName').value = ''; // Clear input after adding
                document.getElementById('error-message').textContent = ''; // Clear error message
                searchUsers(); // Refresh search results
            } else {
                document.getElementById('error-message').textContent = 'Member not found or already added.';
            }
        }

        // Confirm members and send data to the server
        function confirmMembers() {
            if (!locationName) {
                alert('Please enter a location name.');
                return;
            }
            if (members.length > 0) {
                fetch('/createLocation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ locationName, members, owner })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(error => { throw new Error(error.error); });
                    }
                    return response.json();
                })
                .then(data => {
                    alert('Location and members confirmed!');
                    window.location.href = '/'; // Redirect to the home page or another page
                })
                .catch(error => {
                    document.getElementById('error-message').textContent = error.message; // Display error message
                    console.error('Error:', error);
                });
            } else {
                alert('Please add at least one member.');
            }
        }

        // Go back to the previous page
        function goBack() {
            window.history.back();
        }
    </script>
</body>
</html>